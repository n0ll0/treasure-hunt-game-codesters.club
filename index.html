<!DOCTYPE html>
<html lang="en">

  <head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <title>🏴‍☠️ Treasure Hunt Adventure</title>
    <link rel="stylesheet" href="main.css">
    <script src="https://cdn.plot.ly/plotly-latest.min.js"></script>
  </head>

  <body>

    <main>
      <!-- Improved: Keyboard-accessible 3x3 grid using ARIA roles and tabindex -->
      <table class="game" aria-label="Treasure Hunt Grid">
        <tbody>
          <tr>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
          </tr>
          <tr>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
          </tr>
          <tr>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
            <td><button class="button"></button></td>
          </tr>
        </tbody>
      </table>
      <script>
        // Keyboard navigation and radio group logic for the grid
        const gridSize = 3;
        function getCell(row, col) {
          return document.querySelector(
            `.game button[data-row="${row}"][data-col="${col}"]`
          );
        }
        function handleCellClick(btn) {
          // Set aria-checked and tabindex for all buttons
          document.querySelectorAll('.game button').forEach(b => {
            b.setAttribute('aria-checked', 'false');
            b.tabIndex = -1;
          });
          btn.setAttribute('aria-checked', 'true');
          btn.tabIndex = 0;
          btn.focus();
          // Call your game logic here if needed
          if (typeof cellSelected === 'function') cellSelected(btn);
        }
        function handleCellKeydown(e, btn) {
          const row = +btn.dataset.row, col = +btn.dataset.col;
          let nextRow = row, nextCol = col;
          switch (e.key) {
            case 'ArrowUp':
              nextRow = (row + gridSize - 1) % gridSize;
              break;
            case 'ArrowDown':
              nextRow = (row + 1) % gridSize;
              break;
            case 'ArrowLeft':
              nextCol = (col + gridSize - 1) % gridSize;
              break;
            case 'ArrowRight':
              nextCol = (col + 1) % gridSize;
              break;
            case ' ':
            case 'Enter':
              btn.click();
              return;
            default:
              return;
          }
          e.prevenbuttonefault();
          const nextBtn = getCell(nextRow, nextCol);
          if (nextBtn) handleCellClick(nextBtn);
        }
        // Ensure only one button is tabbable at start
        window.addEventListener('DOMContentLoaded', () => {
          const first = getCell(0, 0);
          if (first) first.tabIndex = 0;
        });
      </script>
      </div>

      <p id="message">🏴‍☠️ Welcome, treasure hunter! Ready to find the gold? 🏴‍☠️</p>

      <div class="controls">
        <button class="control-btn" onclick="startNewGame()" start>⚓ Start New Adventure</button>
        <button class="control-btn instructions-btn" popovertarget="instructions">📜 Instructions</button>
        <button class="control-btn dashboard-btn" popovertarget="dashboard">📊 Dashboard</button>
        <button class="control-btn chart-btn" popovertarget="score-chart">📈 Score chart</button>
      </div>

      <div id="instructions" popover="auto">
        <div class="instructions-panel">
          <h3>🗺️ How to Play</h3>
          <p>🏴‍☠️ Click on the circles to search for the hidden treasure!</p>
          <p>💰 Find the treasure in the fewest attempts to get a higher score!</p>
          <p>⭐ Score = 10 - (number of attempts)</p>
          <button popovertarget="instructions" popovertargetaction="hide">Got it!</button>
        </div>

      </div>

      <div id="score-chart" popover="manual">
        <div class="chart-panel">
          <h3>📈 Score History</h3>
          <div id="stats"></div>
          <script>
            const container = document.getElementById('score-chart');
            function updateStatsSize() {
              const stats = document.getElementById('stats');
              if (!stats || !container) return;
              const rect = container.getBoundingClientRect();
              stats.style.width = Math.max(window.innerWidth < 540 ? 250 : 500, rect.width * 0.8) + 'px';
              stats.style.height = (window.innerHeight < 400 ? 300 : 380) + 'px';
              // Refresh Plotly chart if it exists
              if (window.Plotly && stats.children.length > 0) {
                Plotly.Plots.resize(stats);
              }
            }
            window.addEventListener('resize', updateStatsSize);
            container.addEventListener("toggle", updateStatsSize);
            updateStatsSize();
          </script>
          <button popovertarget="score-chart" popovertargetaction="hide">Close</button>
        </div>
      </div>

      <div id="dashboard" popover="manual">
        <div class="dashboard-panel">
          <h3>📊 Treasure Hunter Dashboard</h3>

          <!-- Main Stats Cards -->
          <div class="stats-cards">
            <div class="stat-card total-score">
              <div class="stat-icon">💰</div>
              <div class="stat-content">
                <div class="stat-value" table-total>0</div>
                <div class="stat-label">Total Doubloons</div>
              </div>
            </div>

            <div class="stat-card games-played">
              <div class="stat-icon">🏴‍☠️</div>
              <div class="stat-content">
                <div class="stat-value" table-gameNr>0</div>
                <div class="stat-label">Expeditions</div>
              </div>
            </div>

            <div class="stat-card average-score">
              <div class="stat-icon">⭐</div>
              <div class="stat-content">
                <div class="stat-value" table-avg>0</div>
                <div class="stat-label">Avg. Haul</div>
              </div>
            </div>

            <div class="stat-card best-score">
              <div class="stat-icon">🏆</div>
              <div class="stat-content">
                <div class="stat-value" id="best-score">0</div>
                <div class="stat-label">Best Haul</div>
              </div>
            </div>
          </div>

          <!-- Achievement Badges -->
          <div class="achievements">
            <h4>🏆 Pirate Achievements</h4>
            <div class="badge-container">
              <div class="achievement-badge" id="perfect-shot-badge">
                <span class="badge-icon">🎯</span>
                <span class="badge-name">Perfect Shot</span>
                <span class="badge-count" id="perfect-shots">0</span>
                <button class="badge-info-btn" popovertarget="perfect-shot-hint" aria-label="Perfect Shot Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="perfect-shot-hint">
                <div class="panel">
                  Awarded for finding the treasure on your very first attempt in a game!
                </div>
              </div>
              <div class="achievement-badge" id="quick-draw-badge">
                <span class="badge-icon">⚡</span>
                <span class="badge-name">Quick Draw</span>
                <span class="badge-count" id="quick-draws">0</span>
                <button class="badge-info-btn" popovertarget="quick-draw-hint" aria-label="Quick Draw Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="quick-draw-hint">
                <div class="panel">
                  Awarded for making a fast and accurate move!
                </div>
              </div>
              <div class="achievement-badge" id="treasure-master-badge">
                <span class="badge-icon">👑</span>
                <span class="badge-name">Treasure Master</span>
                <span class="badge-count" id="treasure-master">0</span>
                <button class="badge-info-btn" popovertarget="master-hint" aria-label="Treasure Master Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="master-hint">
                <div class="panel">
                  Awarded for finding the treasure in three consecutive games with a score of 9 or higher!
                </div>
              </div>
              <div class="achievement-badge" id="persistent-badge">
                <span class="badge-icon">🗡️</span>
                <span class="badge-name">Persistent</span>
                <span class="badge-count" id="persistent-count">0</span>
                <button class="badge-info-btn" popovertarget="persistent-hint" aria-label="Persistent Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="persistent-hint">
                <div class="panel">
                  Awarded for never giving up: play 10 or more games, regardless of your score!
                </div>
              </div>
              <div class="achievement-badge" id="board-master-badge">
                <span class="badge-icon">🎯</span>
                <span class="badge-name">Board Master</span>
                <span class="badge-count" id="board-master-count">0</span>
                <button class="badge-info-btn" popovertarget="board-master-hint" aria-label="Board Master Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="board-master-hint">
                <div class="panel">
                  LEGENDARY! Fill the entire 9-cell board with treasures!
                </div>
              </div>
              <div class="achievement-badge" id="treasure-hoarder-badge">
                <span class="badge-icon">💰</span>
                <span class="badge-name">Treasure Hoarder</span>
                <span class="badge-count" id="treasure-hoarder-count">0</span>
                <button class="badge-info-btn" popovertarget="treasure-hoarder-hint" aria-label="Treasure Hoarder Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="treasure-hoarder-hint">
                <div class="panel">
                  Collect treasures across multiple games! Awarded for every 5 treasures collected.
                </div>
              </div>
              <div class="achievement-badge" id="clean-slate-badge">
                <span class="badge-icon">🧹</span>
                <span class="badge-name">Clean Slate</span>
                <span class="badge-count" id="clean-slate-count">0</span>
                <button class="badge-info-btn" popovertarget="clean-slate-hint" aria-label="Clean Slate Info"
                  style="background:none;border:none;box-shadow:none;padding:0;color:white;font-weight:100;">🛈</button>
              </div>
              <div popover="auto" id="clean-slate-hint">
                <div class="panel">
                  Complete the full board and choose to reset! Letting go brings new opportunities.
                </div>
              </div>
            </div>
          </div>

          <!-- Leaderboard Style Recent Games -->
          <div class="recent-games">
            <h4>⚓ Recent Expeditions</h4>
            <div class="games-list" id="recent-games-list">
              <div class="no-games">🗺️ No expeditions yet, matey!</div>
            </div>
          </div>

          <button class="action-btn" popovertarget="dashboard" popovertargetaction="hide">Close Dashboard</button>

          <button class="action-btn reset-stats-btn" id="resetStatsBtn" popovertarget="reset-confirmation">
            🔄 Reset All Stats
          </button>
          <div id="reset-confirmation" popover="auto">
            <div class="confirmation-panel">
              <h3>⚠️ Confirm Reset</h3>
              <p>Are you sure you want to reset all your treasure hunting statistics?</p>
              <p><b>This action cannot be undone!</b></p>
              <div class="confirmation-buttons">
                <button onclick="resetGameStats()" class="confirm-btn">🔄 Yes, Reset Everything</button>
                <button popovertarget="reset-confirmation" popovertargetaction="hide" class="cancel-btn">❌
                  Cancel</button>
              </div>
            </div>
          </div>
        </div>
      </div>


    </main>

    <script src="./gameScript.js"></script>
  </body>

</html>